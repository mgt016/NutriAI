<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriAI - Create Diet Plan</title>
    <link rel="stylesheet" href="rightbar-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .diet-plan-container {
          margin-top: 30px;
        }
        
        .diet-plan-container h2 {
          margin-bottom: 20px;
          font-size: 1.8rem;
          color: var(--primary-color);
        }
        
        #day-selector {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          margin-bottom: 20px;
        }
        
        .day-button {
          padding: 8px 16px;
          background-color: #f0f0f0;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        
        .day-button.active {
          background-color: var(--primary-color);
          color: white;
        }
        
        .day-card {
          margin-bottom: 30px;
        }
        
        .day-card h3 {
          margin-bottom: 15px;
          font-size: 1.4rem;
          color: var(--primary-color);
        }
        
        .day-card h4 {
          margin-bottom: 10px;
          font-size: 1.2rem;
          color: var(--text-color);
        }
        /* ... (previous styles remain unchanged) ... */

/* Aesthetic Table Styles */
.meal-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-bottom: 1.5rem;
  background-color: #ffffff;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  overflow: hidden;
}
.meal-table tr{
    width: 100%;
}
.meal-table th,
.meal-table td {
  padding: 1rem;
  text-align: left;
}

.meal-table th {
  background-color: #f0f4f8;
  color: #2d3748;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  border-bottom: 2px solid #e2e8f0;
}

.meal-table td {
  color: #4a5568;
  border-bottom: 1px solid #e2e8f0;
}

.meal-table tr:last-child td {
  border-bottom: none;
}

.meal-table td:first-child {
  font-weight: 500;
  color: #2d3748;
}

.meal-table tr:hover {
  background-color: #f7fafc;
}

/* Responsive design */
@media screen and (max-width: 768px) {
  .meal-table {
    font-size: 0.875rem;
  }

  .meal-table th,
  .meal-table td {
    padding: 0.75rem;
  }

  .meal-table th {
    display: none;
  }

  .meal-table td {
    display: block;
    text-align: right;
    padding-left: 50%;
    position: relative;
  }

  .meal-table td:before {
    content: attr(data-label);
    position: absolute;
    left: 0.75rem;
    width: 45%;
    padding-right: 10px;
    text-align: left;
    font-weight: 600;
    color: #2d3748;
  }

  .meal-table td:first-child {
    text-align: left;
    padding-left: 0.75rem;
    font-weight: 600;
    color: #2d3748;
    background-color: #f0f4f8;
  }

  .meal-table td:first-child:before {
    content: none;
  }
}

/* ... (rest of the styles remain unchanged) ... */


        
        /* ... (rest of the styles remain unchanged) ... */
        
        
        </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
          <div class="logo">
              <img src="images\logo1.jpg" alt="NutriAI Logo">
              <span>NutriAI</span>
          </div>
          <ul class="nav-items">
              <li data-page="index.html" ><i class="fas fa-chart-pie"></i> Overview</li>
              <li data-page="diet.html"><i class="fas fa-utensils"></i> My Diet</li>
              <li data-page="bmr.html"><i class="fas fa-heartbeat"></i> BMR</li>
              <li data-page="profile.html"><i class="fas fa-user"></i> Profile</li>
              <li data-page="settings.html"><i class="fas fa-cog"></i> Settings</li>
              <li data-page="help.html"><i class="fas fa-question-circle"></i> Help Center</li>
          </ul>
          <div class="logout">
              <i class="fas fa-sign-out-alt"></i> Logout
          </div>
      </nav>


        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <!-- <input type="search" placeholder="Search" class="search-bar"> -->
                <div class="user-actions">
                    <span class="notification"><i class="fas fa-bell"></i></span>
                    <span class="more-options"><i class="fas fa-ellipsis-v"></i></span>
                </div>
            </header>

            <div class="content">
                <h1>Create Diet Plan</h1>
                <div class="card">
                    <form id="diet-plan-form">
                        <div class="form-group">
                            <label for="goal">Goal</label>
                            <select id="goal" required>
                                <option value="">Select your goal</option>
                                <option value="weight-loss">Weight Loss</option>
                                <option value="muscle-gain">Muscle Gain</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                        <!-- <div class="form-group">
                            <label for="dietary-restrictions">Dietary Restrictions</label>
                            <select id="dietary-restrictions" multiple>
                                <option value="vegetarian">Vegetarian</option>
                                <option value="vegan">Vegan</option>
                                <option value="gluten-free">Gluten-free</option>
                                <option value="dairy-free">Dairy-free</option>
                                <option value="nut-free">Nut-free</option>
                            </select>
                        </div> -->
                        <div class="form-group">
                            <label for="activity-level">Activity Level</label>
                            <select id="activity-level" required>
                                <option value="">Select your activity level</option>
                                <option value="sedentary">Sedentary (Little to no exercise)</option>
                                <option value="lightly active">Light Activity (1-3 days per week)</option>
                                <option value="moderately active">Moderate Activity (3-5 days per week)</option>
                                <option value="very active">Active (6-7 days per week)</option>
                                <option value="super active">Very Active (Twice per day intense training)</option>
                            </select>
                        </div>
                        <!-- <div class="form-group">
                            <label for="meal-preference">Meal Preference</label>
                            <select id="meal-preference" required>
                                <option value="">Select your meal preference</option>
                                <option value="3-meals">3 meals per day</option>
                                <option value="4-meals">4 meals per day</option>
                                <option value="5-meals">5 meals per day</option>
                                <option value="6-meals">6 meals per day</option>
                            </select> -->
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Diet Plan</button>
                    </form>
                </div>
                <div class="diet-plan-container">
                    <h2>7-Day Personalized Diet Plan</h2>
                    <div id="day-selector"></div>
                    <div id="diet-plan-result" class="card">
                        <div id="diet-plan-content"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="script.js"></script>
    <script>
        let mealPlanData = null; // Declare globally

document.getElementById('diet-plan-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const goal = document.getElementById('goal').value;
    const activityLevel = document.getElementById('activity-level').value;

    // Extract user ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');

    // Retrieve user data from local storage
    const userData = JSON.parse(localStorage.getItem("userData"));

    if (!userData || !userId) {
        document.getElementById('diet-plan-content').innerHTML = '<p>Error: Missing user data. Please log in again.</p>';
        return;
    }

    // Construct request data from stored user details
    const requestData = {
        weight: userData.weight || 70,
        height: userData.height || 175,
        age: calculateAge(userData.dateOfBirth) || 25,
        gender: userData.gender || "male",
        activity_level: activityLevel,
        goal: goal,
        user: userId
    };

    document.getElementById('diet-plan-result').style.display = 'block';
    document.getElementById('diet-plan-content').innerHTML = '<p>Loading your personalized diet plan...</p>';

    try {
        const response = await fetch('http://localhost:5000/generate-meal-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        mealPlanData = data; // Store response globally

        if (!mealPlanData.days) {
            document.getElementById('diet-plan-content').innerHTML = '<p>Error: Invalid meal plan data.</p>';
            return;
        }

        createDaySelector();  // Call after data is received
        displayMealPlan(Object.keys(mealPlanData.days)[0]);  // Display the first day
    } catch (error) {
        console.error('Error fetching meal plan:', error);
        document.getElementById('diet-plan-content').innerHTML = '<p>Error fetching meal plan. Please try again.</p>';
    }
});

function calculateAge(dobString) {
    if (!dobString) return null;
    const dob = new Date(dobString);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    return age;
}

function createDaySelector() {
  const daySelector = document.getElementById("day-selector")
  daySelector.innerHTML = ""
  Object.keys(mealPlanData.days).forEach((day, index) => {
    const button = document.createElement("button")
    button.textContent = day
    button.classList.add("day-button")
    if (index === 0) button.classList.add("active")
    button.addEventListener("click", () => displayMealPlan(day))
    daySelector.appendChild(button)
  })
}

function displayMealPlan(selectedDay) {
  if (!mealPlanData || !mealPlanData.days[selectedDay]) {
    document.getElementById("diet-plan-content").innerHTML = "<p>No meal plan available.</p>"
    return
  }

  const mealPlan = mealPlanData.days[selectedDay]
  let htmlContent = `<h3>${selectedDay}</h3>`

  Object.keys(mealPlan).forEach((mealType) => {
    htmlContent += `
            <div class="day-card">
                <h4>${mealType}</h4>
                ${generateMealHTML(mealPlan[mealType])}
            </div>
        `
  })

  document.getElementById("diet-plan-content").innerHTML = htmlContent
  updateActiveButton(selectedDay)

  const saveButton = document.createElement("button");
  saveButton.textContent = "Save Meal Plan";
  saveButton.classList.add("btn", "btn-primary");
  saveButton.addEventListener("click", () => saveMealPlan());

  // Append the save button below the meal plan content
  const resultContainer = document.getElementById("diet-plan-result");
  if (!document.getElementById("save-button")) {
    saveButton.id = "save-button";
    resultContainer.appendChild(saveButton);
  }
}

function generateMealHTML(meal) {
  return `
        <table>
            <tr>
    <th style="width: 60%;">Food Items</th>
    <th style="width: 10%;">Calories</th>
    <th style="width: 10%;">Protein</th>
    <th style="width: 10%;">Carbs</th>
    <th style="width: 10%;">Fats</th>
</tr>

            <tr>
                <td>${meal.items.join(", ")}</td>
                <td>${meal.calories} kcal</td>
                <td>${meal.protein}g</td>
                <td>${meal.carbs}g</td>
                <td>${meal.fats}g</td>
            </tr>
        </table>
    `
}

function updateActiveButton(selectedDay) {
  const buttons = document.querySelectorAll(".day-button")
  buttons.forEach((button) => {
    button.classList.remove("active")
    if (button.textContent === selectedDay) {
      button.classList.add("active")
    }
  })
}

async function saveMealPlan() {
  const userId = new URLSearchParams(window.location.search).get('userId');
  if (!userId) {
    alert('User not found. Please log in again.');
    return;
  }

  const requestData = mealPlanData;

  try {
    const response = await fetch('http://localhost:5550/save-meal-plan', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData),
    });

    const data = await response.json();
    if (response.ok) {
      alert('Meal plan saved successfully!');
    } else {
      alert(`Error: ${data.error || 'Failed to save meal plan'}`);
    }
  } catch (error) {
    console.error('Error saving meal plan:', error);
    alert('Failed to save meal plan. Please try again later.');
  }
}


</script>
    
</body>
</html>